imports = ["postgres.nix"]

[services.postgres]
package = "pkgs.postgresql_16"
setupPostgresOnStartup = true
listenAddresses = "*"

[[env]]
name = "DBNAME"
value = "ms"

[[env]]
name = "PGPORT"
value = "7700"

[[env]]
name = "MS_DATABASE_URL"
eval = 'postgres:///$DBNAME?port=$PGPORT\&host=$PGHOST'

[[env]]
name = "MS_DATABASE_URL_LOCALHOST"
eval = 'postgres://${USER:-$(id -nu)}@localhost:$PGPORT/$DBNAME'

[[commands]]
package = "refinery-cli"
name = "refinery"

[[commands]]
name = "setup-db"
command = '''
createdb  -h $PGDATA -p $PGPORT $DBNAME
pushd $PRJ_ROOT/backend
refinery migrate -e MS_DATABASE_URL_LOCALHOST
          '''

[[commands]]
name = "reset-db"
command = '''
rm -rf $PGDATA
setup-postgres
postgres
          '''